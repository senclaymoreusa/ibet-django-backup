files:
  "/usr/local/bin/test_cron.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      INSTANCE_ID=`curl http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null`
      REGION=`curl -s http://169.254.169.254/latest/dynamic/instance-identity/document 2>/dev/null | jq -r .region`
      # Find the Auto Scaling Group name from the Elastic Beanstalk environment
      ASG=`aws ec2 describe-tags --filters "Name=resource-id,Values=$INSTANCE_ID" \
          --region $REGION --output json | jq -r '.[][] | select(.Key=="aws:autoscaling:groupName") | .Value'`
      # Find the first instance in the Auto Scaling Group
      FIRST=`aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names $ASG \
          --region $REGION --output json | \
          jq -r '.AutoScalingGroups[].Instances[] | select(.LifecycleState=="InService") | .InstanceId' | sort | head -1`
      # If the instance ids are the same exit 0
      [ "$FIRST" = "$INSTANCE_ID" ]

  "/usr/local/bin/post_django_onebook.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      /usr/local/bin/test_cron.sh || exit
      curl -v -X POST "http://gd-background-test.ap-northeast-1.elasticbeanstalk.com/games/api/onebook/get_bet_detail" >  /dev/null 2>&1
      
  "/etc/cron.d/background_task_onebook":
    mode: "000644"
    owner: root
    group: root
    content: |
      */5 * * * * root /usr/local/bin/post_django_onebook.sh

  "/usr/local/bin/post_django_kaiyuan.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      /usr/local/bin/test_cron.sh || exit
      curl -v -X POST "http://gd-background-test.ap-northeast-1.elasticbeanstalk.com/games/api/ky/getbets/" >  /dev/null 2>&1
      
  "/etc/cron.d/background_task_kaiyuan":
    mode: "000644"
    owner: root
    group: root
    content: |
      */4 * * * * root /usr/local/bin/post_django_kaiyuan.sh

  "/usr/local/bin/post_django_gamebet_copy.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      /usr/local/bin/test_cron.sh || exit
      curl -v -X POST "http://gd-background-test.ap-northeast-1.elasticbeanstalk.com/background/api/gamebet_copy" >  /dev/null 2>&1
      
  "/etc/cron.d/background_task_gamebet_copy":
    mode: "000644"
    owner: root
    group: root
    content: |
      * */2 * * * root /usr/local/bin/post_django_gamebet_copy.sh

  "/usr/local/bin/post_django_transaction_copy.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      /usr/local/bin/test_cron.sh || exit
      curl -v -X POST "http://gd-background-test.ap-northeast-1.elasticbeanstalk.com/background/api/transaction_copy" >  /dev/null 2>&1
      
  "/etc/cron.d/background_task_transaction_copy":
    mode: "000644"
    owner: root
    group: root
    content: |
      * */2 * * * root /usr/local/bin/post_django_transaction_copy.sh 

  "/usr/local/bin/post_django_user_action_copy.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      /usr/local/bin/test_cron.sh || exit
      curl -v -X POST "http://gd-background-test.ap-northeast-1.elasticbeanstalk.com/background/api/user_action_copy" >  /dev/null 2>&1
      
  "/etc/cron.d/background_task_user_action_copy":
    mode: "000644"
    owner: root
    group: root
    content: |
      * */2 * * * root /usr/local/bin/post_django_user_action_copy.sh 

commands:
    remove_old_cron:
        command: "rm -f /etc/cron.d/*.bak"
        ignoreErrors: true
      