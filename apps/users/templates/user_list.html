{% extends 'xadmin/base_site.html' %}

{% block content %} 
<div class="row">
    <div class='col-md-4'><h1>USER LIST</h1></div>
    <div class='col-md-8'>
        <!-- {% block time_search %} -->
        <label>Date Range</label>
        <div class="row">
            <div class='col-md-4'>
                    <!-- <input class="form-control" placeholder="From" id="search-from" name='search-from'></input> -->
                <div class='input-group date' id='user_list_time_from'>
                    <input type='text' class="form-control" placeholder="From" id='user_list_time_from_input' />
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
            <div class='col-md-4'>
                    <!-- <input class="form-control" placeholder="To" id='search-to' name='search-from'></input> -->
                <div class='input-group date' id='user_list_time_to'>
                    <input type='text' class="form-control" placeholder="To"  id='user_list_time_to_input'/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
            <div class='col-md-4'>
                <button id="user_list_time_submit" type="submit" class="btn btn-primary">Submit</button>
            </div>
        </div>
        <!-- {% endblock %} -->
    </div>
</div>

<div style='overflow-x: scroll;'>
<table class="table user_list_table">
<!-- <table style='overflow-x: scroll;'> -->
    <thead class="thead-dark">
        <tr>
            <th scope="col">#</th>
            <th scope="col">USERNAME</th>
            <th scope="col">USER ATTRIBUTE</th>
            <th scope="col">RISK LEVEL</th>
            <th scope="col">BALANCE</th>
            <th scope="col">PRODUCT ATTRIBUTE</th>
            <th scope="col">TIME OF REGISTRATION</th>
            <th scope="col">TIME OF FTD</th>
            <th scope="col">TIME OF VERIFICATION</th>
            <th scope="col">ID LOCATION</th>
            <th scope="col">LAST LOGIN TIME</th>
            <th scope="col">LAST BETTING TIME</th>
            <th scope="col">LOGIN COUNTS</th>
            <th scope="col">BETTING COUNTS</th>
            <th scope="col">TURNOVER AMOUNT</th>
            <th scope="col">DEPOSIT COUNTS</th>
            <th scope="col">DEPOSIT AMOUNT</th>
            <th scope="col">WITHDRAWAL COUNTS</th>
            <th scope="col">WITHDRAWAL AMOUNT</th>
            <th scope="col">GGR AMOUNT</th>
            <th scope="col">COUNTRIBUTION</th>
            <th scope="col">LAST LOGIN IP</th>
            
            
        </tr>
    </thead>
    <tbody id="tansaction_tbody" id='user_list_tbody'>
        {% for user in user_data %} 
        <tr>
            <th scope="row">{{ forloop.counter }}</th>
            <td><a href="{% url 'xadmin:user_detail' user.id %}">{{ user.username }}</a></td>
            <!-- <td>{{ trans }}</td> -->
            <td>{{ user.user_attribute }}</td>
            <td>{{ user.risk_level }}</td>
            <td>{{ user.balance|floatformat:2 }}</td>
            <td>{{ user.product_attribute }}</td>
            {% if user.time_of_registration %}
                <td>{{ user.time_of_registration }}</td>
            {% else %}
                <td></td>
            {% endif %}
            {% if user.ftd_time %}
                <td>{{ user.ftd_time }}</td>
            {% else %}
                <td></td>
            {% endif %}
            <!-- <td>{{ user.ftd_time }}</td> -->
            <td>{{ user.verfication_time }}</td>
            <td>{{ user.id_location }}</td>
            <td>{{ user.last_login_time }}</td>
            <td>{{ user.last_betting_time }}</td>
            <td id='user_login_times_{{ forloop.counter }}'>{{ user.login }}</td>
            <td id='user_bettin_times_{{ forloop.counter }}'>{{ user.betting }}</td>
            <td>{{ user.turnover }}</td>
            <td id='user_deposit_times_{{ forloop.counter }}'>{{ user.deposit }}</td>
            <td id='user_deposit_amount_{{ forloop.counter }}'>{{ user.deposit_amount.amount__sum|floatformat:2 }}</td>
            <td id='user_withdrawal_times_{{ forloop.counter }}'>{{ user.withdrawal }}</td>
            <td id='user_withdrawal_amount_{{ forloop.counter }}'>{{ user.withdrawal_amount.amount__sum|floatformat:2 }}</td>
            <td>{{ trans.status }}</td>
            <td>{{ trans.status }}</td>
            <td>{{ user.last_logint_ip.ip_addr }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>


<script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.css" rel="stylesheet"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>


<script>

// $('#datetimepicker1').datetimepicker();

$(document).ready(function() {
    var csrftoken = $.cookie("csrftoken");
    // console.log(csrftoken);

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    $(function () {
        $('#user_list_time_from').datetimepicker();
        $('#user_list_time_to').datetimepicker();
    });

    $('#user_list_time_submit').click( function(e) {
        e.preventDefault();
        var time_from = $('#user_list_time_from_input').val();
        // console.log(time_from);
        time_from = moment(time_from).format('YYYY-MM-DD HH:mm');
        // time_from = time_from.format('YYYY-MM-DD HH:mm');
        var time_to = $('#user_list_time_to_input').val();
        // console.log(time_to);
        time_to = moment(time_to).format('YYYY-MM-DD HH:mm');
        // time_to = time_to.format('YYYY-MM-DD HH:mm');
        // console.log(time_from);

        $.ajax({
            type:'POST',
            url:"{% url 'xadmin:user_list' %}",
            data:{ 
                'type': 'user_list_time_range_filter',
                'from': time_from,
                'to': time_to
            },
            success:function(data) {

                data.forEach(i => console.log("data: " + i.login_times));
                // console.log("!!!!!" + data);
                for (var i = 0; i < data.length; i++) {
                    $("#user_login_times_" + (i+1)).empty();
                    $("#user_bettin_times_" + (i+1)).empty();
                    $("#user_deposit_times_" + (i+1)).empty();
                    $("#user_deposit_amount_" + (i+1)).empty();
                    $("#user_withdrawal_times_" + (i+1)).empty();
                    $("#user_withdrawal_amount_" + (i+1)).empty();
                    // console.log(data[i].deposit_amount.amount__sum);
                    var content = "<td id='user_login_times_" + (i+1) + "'>" + data[i].login_times + "</td>";
                    $("#user_login_times_" + (i+1)).append(content);
                    content = "<td id='user_bettin_times_" + (i+1) + "'>" + data[i].betting_times + "</td>";
                    $("#user_bettin_times_" + (i+1)).append(content);
                    content = "<td id='user_deposit_times_" + (i+1) + "'>" + data[i].deposit_times + "</td>";
                    $("#user_deposit_times_" + (i+1)).append(content);
                    content = "<td id='user_deposit_amount_" + (i+1) + "'>" + cleanField(data[i].deposit_amount.amount__sum) + "</td>";
                    $("#user_deposit_amount_" + (i+1)).append(content);
                    content = "<td id='user_withdrawal_times_" + (i+1) + "'>" + data[i].withdrawal_times + "</td>";
                    $("#user_withdrawal_times_" + (i+1)).append(content);
                    content = "<td id='user_withdrawal_amount_" + (i+1) + "'>" + cleanField(data[i].withdrawal_amount.amount__sum) + "</td>";
                    $("#user_withdrawal_amount_" + (i+1)).append(content);
                }
            }
        });
    });

    function cleanField(field) {
        if (field === null || field === undefined) {
            return "";
        }
        return cleanFloatField(field);
    }

    function cleanFloatField(field) {
        return field.toFixed(2);
    }

});

</script>
        



{% endblock %}