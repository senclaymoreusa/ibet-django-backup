{% extends 'xadmin/base_site.html' %}
{% load i18n %}

{% block content-nav %}
{% endblock %}


{% block content %} 
<div>
    <div class="row">
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" id="search" class="form-control" placeholder="Enter member ID, name, phone or email" >
                <span id="search-btn" class="input-group-addon" style="background-color: #428bca; color:white"><span class="glyphicon glyphicon-search"></span></span>
            </div>
        </div>
    </div>
    <div class="row" style="margin-top:20px;">
        <div class="col-md-2">
            <div style="width: 100%; height: 800px; background-color: #f3f3f3;">
                <div style="padding:15px 10px;">
                    <label style="width:98%;" class="btn btn-primary" type="button">Upload CSV <input id="upload" type="file" style="display: none;"></label>
                    <div class="row" style="margin-top:15px;">
                        <div class="custom-file-label col-md-6"></div>
                        <div class="col-md-6 delete" style="display: none;">
                            <button hidden type="button" class="btn btn-defaul" style="background-color:rgb(199, 89, 82)" onclick="deleteFile()">
                                <span class="glyphicon glyphicon-trash" style='color:white'></span>
                            </button>
                        </div>
                    </div>
                </div>
                <div style="padding:0px 10px; margin-bottom:10px;" >
                    <label class="role-title">MARKET</label>
                    <select id="market-select" multiple="multiple" class="form-control">
                            <optgroup label="ibet" class="ibetMarkets">   
                                <option value="ALL" id="ibetALL">ALL</option>
                                {% for market in markets.ibetMarket_options %}
                                    <option value="{{ market.code }}" id="{{  market.name }}">{{ market.code }}</option>
                                {% endfor %}
                                <!-- <option value="CNY">CNY</option>
                                <option value="THB">THB</option>
                                <option value="VN">VN</option>
                                <option value="DE">DE</option>
                                <option value="FI">FI</option>
                                <option value="NL">NL</option>
                                <option value="NO">NO</option>
                                <option value="UK">UK</option> -->
                            </optgroup>
                            <optgroup label="Letou" class="letouMarkets">   
                                <!-- <option value="all">ALL</option>
                                <option value="CNY">CNY</option>
                                <option value="THB">THB</option>
                                <option value="VN">VN</option> -->
                                <option value="ALL" id="letouALL">ALL</option>
                                {% for market in markets.letouMarket_options %}
                                    <option value="{{ market.code }}" id="{{  market.name }}">{{ market.code }}</option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                    <!-- <br /> -->
                    <div style="margin:0px 10px; margin-bottom:10px;" >
                        <label class="role-title">STATUS</label>
                        <select class="form-control" id="time-period-options">
                            <option value="-1" selected>Select...</option>
                            <option value="0">Active</option>
                            <option value="1">Inactive</option>
                        </select>
                    </div>
                    <!-- <br /> -->
                    <div style="margin: 0px 10px;">
                        <label class="role-title">LAST ACTIVE DATE</label>
                        <div class="row" id="date-range">
                            <div class='col-md-6' style="padding-right:0px;">
                                <div class='input-group date' data-provide="datepicker">
                                    <input type='text' class="form-control" placeholder="From" id="from"/>
                                    <span class="input-group-addon" style="display: none;">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                            </div>
                            <div class='col-md-6' style="padding-left:0px;">
                                <div class='input-group date' data-provide="datepicker">
                                    <input type='text' class="form-control" placeholder="To" id="to"/>
                                    <span class="input-group-addon" style="display: none;">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin:10px">
                        <label class="role-title">REGISTERATION DATE</label>
                        <div class="row" id="date-range">
                            <div class='col-md-6' style="padding-right:0px;">
                                <div class='input-group date' data-provide="datepicker">
                                    <input type='text' class="form-control" placeholder="From" id="from"/>
                                    <span class="input-group-addon" style="display: none;">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                            </div>
                            <div class='col-md-6' style="padding-left:0px;">
                                <div class='input-group date' data-provide="datepicker">
                                    <input type='text' class="form-control" placeholder="To" id="to"/>
                                    <span class="input-group-addon" style="display: none;">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-left:10px; margin-top:15px;">
                        <input type="checkbox"><label style="font-size:13px; margin-left:7px;">Show affiliates only</label>
                    </div>
                    <div style="margin-left:10px; margin-top:10px;">
                        <input type="checkbox"><label style="font-size:13px; margin-left:7px;">Include data per product</label>
                    </div>
                    <div style="margin-left:35px;margin-top:20px;">
                        <button type="button" class="btn btn-success" id="submit_btn">Generate report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>
$(document).ready(function() {

    document.getElementById("upload").addEventListener("change", upload, false);

    $('input[type="file"]').change(function(e){
        var fileName = e.target.files[0].name;
        $('.custom-file-label').html(fileName);
        // $('.delete').setAttribute("visibility", "visible");
        $('.delete').css("display", "");
    });

    $(function() {
        $('#device-select').multiselect({
            includeSelectAllOption: true,
        });
    })

    $(function() {
        $('#channel-select').multiselect({
            includeSelectAllOption: true,
        });
    })

    $(function() {
        $('#market-select').multiselect({

            includeSelectAllOption: true,
            allSelectedText: 'All',
            // enableCollapsibleOptGroups: true,
            enableHTML: true,
            optionLabel: function(element) {
                if ($(element).attr('value') !== "ALL")
                    return '<img src="{{ imagePath }}' + $(element).attr('id') + '.svg" class="flag-icon"><label style="margin-left:10px">' + $(element).attr('value') + '</label>';
                else
                    return $(element).attr('value')
            },
            // onChange: function(option, checked, select) {
            //     // console.log(option, checked, select);
            //     if (checked) {
            //         console.log(option.context.value);
            //         selectOpt = selectOpt + option.context.value + ",";
            //     }
            // }
        });
    })

    deleteFile = function () {
        document.getElementById("upload").value = "";
        $('.custom-file-label').html("");
        $('.delete').css("display", "none");
        
    }
})

function upload(e) {

    // console.log(e);
    var data = null;
    var file = e.target.files[0];
    var members = [];

    var reader = new FileReader();
    reader.readAsText(file);
    reader.onload = function (event) {
        var csvData = event.target.result;
        // console.log(csvData);
        var parsedCSV = d3.csv.parseRows(csvData);
        // console.log(parsedCSV);
        parsedCSV.forEach(function (d, i) {
            // console.log(d, i);
            var usernameIdx = 1;
            if (i == 0) {
                for (var x = 0; x < d.length; x++) {
                    if (d[x].toLowerCase() === "username") {
                        usernameIdx = x;
                    }
                }
            } else {
                members.push(d[usernameIdx]);
            }
            // document.getElementById(d[0]).value = d[1];
        });
        getHowManyUser(members);
    }
}

function getHowManyUser(members) {
    console.log(members);
    var data = {
                csrfmiddlewaretoken: "{{ csrf_token }}",
                members: JSON.stringify(members),
                type: "get_member_number"
            };
    console.log(data);
    var url = "{% url 'xadmin:members_report' %}"

    $.ajax({
        type: "GET",
        url: url,
        data,
        success: function(data)
        {
            console.log(data);
        }
    });
}
</script>
{% endblock %}