{% extends 'xadmin/base_site.html' %}
{% block content-nav %}
{% endblock %}
{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" crossorigin="anonymous"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.2.1/typeahead.bundle.js"></script>
<script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<!-- <link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.css" rel="stylesheet"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet" type="text/css" />


<style>
form {
  padding: 0 16px 16px 16px;
}

label {
  height: 13px;
  font-family: Helvetica;
  font-size: 11px;
  font-weight: normal;
  font-style: normal;
  font-stretch: normal;
  line-height: normal;
  letter-spacing: normal;
  color: #4a4a4a;
}

thead {
  height: 12px;
  font-family: Helvetica;
  font-size: 10px;
  font-weight: normal;
  font-style: normal;
  font-stretch: normal;
  line-height: normal;
  letter-spacing: normal;
  color: #4a4a4a;
}

td {
  border: solid 4px #ffffff;
}

tbody>tr:nth-child(odd)>td, 
tbody>tr:nth-child(odd)>th {
   background-color: #f3f3f3;
}

.form-group {
  padding-top: 20px;
}

.modal-header {
  border-radius: 4px;
  border: solid 1px #bdbdbd;
  background-color: #f5f5f5;
}

.modal-header .close {
  margin-top: -16px;
}

.row {
  margin: 0 0 0 0;
}

.form-check-label {
  margin-right: 20px;
}

.btn-secondary {
  margin: 10px 10px 10px 10px;
}

#content_text {
  height: 393px;
  border: solid 1px #bdbdbd;
}
.twitter-typeahead {
    width:100%;
}

.tt-input {
    width: 100% !important;
}
.tt-suggestion {
  font-size: 14px;
}


.ui-autocomplete { z-index:2147483647; }

</style>

<div class="row">
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bd-example-modal-lg">New message</button>
  <a role="button" class="btn btn-primary" href="/xadmin/audit">
    Notifications <span class="badge badge-light">{{ waiting_list }}</span>
  </a>

  <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div id="mydialog" class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">New Message</h3>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="{% url 'xadmin:notification' %}" method="post" id="newmsg">
        {% csrf_token %}
          <div class="form-group">
            <label for="campaign">CAMPAIGN</label>
            <select name="campaign" class="form-control">
              <option value="-1">SELECT CAMPAIGN...</option>
              {% for campaign in campaignOpt %}
                <option value="{{ campaign.id }}">{{ campaign.name }}</option>
              {% endfor %}
              <!-- <option value="CAMPAIGN1">CAMPAIGN1</option>
              <option value="CAMPAIGN2">CAMPAIGN2</option>
              <option value="CAMPAIGN3">CAMPAIGN3</option> -->
            </select>
          </div>
          <div class="form-group">
            <label for="notifiers">SEND TO</label>
            <div class="input-group" >
              <input type="text" id="sendto" class="form-control" placeholder="Enter ID username, name, phone or email" autocomplete="None">
              <span id="search-notifier-btn" class="input-group-addon" style="background-color: #ffffff; color:#2e2e2e"><span class="glyphicon glyphicon-search"></span></span>
            </div>
          </div>
          <div class="form-group">
            <label for="subject">MESSAGE SUBJECT</label>
            <input type="text" class="form-control" name="subject" placeholder="Subject...">
          </div>
          {% comment %} <div class="form-group">
            <label for="tags">MESSAGE BODY</label>
            <textarea name="content_text" id="editor" rows="30">This is some sample content.</textarea>
          </div> {% endcomment %}
          <div class="form-group">
            <label for="content">MESSAGE BODY</label>
            <div name="content_text" id="content_text" class="row" contenteditable="true">
            </div>
            <div class="row" style="border: 1px solid #bdbdbd; background-color: #f4f4f4">
              <button type="button" class="btn btn-secondary" id="italic"><i class="fa fa-italic"></i></button>
              <button type="button" class="btn btn-secondary" id="bold"><i class="fa fa-bold"></i></button>
              <button type="button" class="btn btn-secondary" id="underline"><i class="fa fa-underline"></i></button>
              <button type="button" class="btn btn-secondary" id="" disabled><i class="far fa-image"></i></button>
              <button type="button" class="btn btn-secondary" id="" disabled><i class="fas fa-percentage"></i></button>
            </div>
          </div>
          <div class="form-group">
            <label for="notification_method" class="col-2 col-form-label">Notification Methods</label>
            <div class="form-check row">
              <input class="form-check-input" type="checkbox" name="direct_check">
              <label class="form-check-label" for="direct_check">
                  Direct Message
              </label>
              <input class="form-check-input" type="checkbox" name="email_check">
              <label class="form-check-label" for="email_check">
                  Email
              </label>
              <input class="form-check-input" type="checkbox" name="SMS_check">
              <label class="form-check-label" for="SMS_check">
                  SMS
              </label>
              <input class="form-check-input" type="checkbox" name="push_check">
              <label class="form-check-label" for="push_check">
                  Push Notification
              </label>
            </div>
          </div>
          <button type="button" id="send" class="btn btn-success">Send</button>
          <button type="button" class="btn btn-primary" disabled>Automate</button>
          <button type="button" class="btn btn-primary" data-dismiss="modal" aria-label="Close">Cancel</button>
        </form>
      </div>
    </div>
  </div>
<div class="row" style="margin-top: 36px">
  <div class='col-md-4' style="padding-left: 0">
    <div class="input-group">
      <input type="text" id="search" class="form-control" placeholder="Enter member, campaign, bouns, keyword...">
      <span id="search-btn" class="input-group-addon" style="background-color: #428bca; color:white"><span class="glyphicon glyphicon-search"></span></span>
    </div>
  </div>
  <div class='col-md-5' style="padding-left: 0">
  </div>
  <div class='col-md-3'>
    <!-- {% block time_search %} -->
    <label class="detail-info">DATE RANGE</label>
    <div class="row">
        <div class='col-md-5' style="padding: 0px;">
            <div class='input-group'>
              <input type='text' class="form-control" placeholder="From" id='notification_time_from' />
            </div>
        </div>
        <div class='col-md-5' style="padding-left: 5px; padding-right: 0px;">
            <div class='input-group'>
              <input type='text' class="form-control" placeholder="To"  id='notification_time_to'/>
            </div>
        </div>
        <div class='col-md-2' style="padding-left: 7px;">
            <button id="date-search-btn" type="button" class="btn btn-primary"><i class="fa fa-search"></i></button>
            {% comment %} <span id="date-search-btn" class="input-group-addon" style="background-color: #428bca; color:white"><span class="glyphicon glyphicon-search"></span></span> {% endcomment %}
        </div>
    </div>
      <!-- {% endblock %} -->
    </div>
</div>
<div class="col-md-3">
    {% if searchError %}
        <div style="margin-top: 12%;color: red;">{{ searchError }}</div>
    {% endif %}
</div>


<div style="margin-top:25px;">
  <ul class="nav nav-tabs">
    <li id="sent-messages"><a data-toggle="tab" class="tab-label" href="#sent-message">SENT MESSAGES</a></li>
    <li id="automated-messages"><a data-toggle="tab"  class="tab-label" style="width: 220px"  href="#automated-message">AUTOMATED MESSAGES</a></li>
    <li id="drafts"><a data-toggle="tab"  class="tab-label" href="#draft">DRAFTS</a></li>
  </ul>
  <div class="tab-content" style="margin-top:30px;">
    <div id="sent-message" class="tab-pane fade">
      <table>
        <thead class="thead-dark">
          <tr>
            <th style="width: 3%;">#</th>
            <th style="width: 20%;">SUBJECT</th>
            <th style="width: 10%;">CAMPAIGN</th>
            <th style="width: 12%;">SENT TO</th>
            <th style="width: 5%;">BONUS</th>
            <th style="width: 15%;">SENT TIME</th>
            <th style="width: 13%;">AUTHOR</th>
            <th style="width: 5%;">SENT</th>
            <th style="width: 5%;">OPENED</th>
            <th style="width: 5%;">OPEN RATE</th>
            <th style="width: 7%;">BONUS CTR</th>
          </tr>
        </thead>
        <tbody>
          {% for notification in notifications %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ notification.subject }}</td>
              <td>{{ notification.campaign.name }}</td>
              {% if notification.notifiers %}
              {% comment %} <td><a href="{% url 'xadmin:user_detail' notification.notifiers.id %}">{{ notification.notifiers }}</a></td> {% endcomment %}
              <td>{{ notification.sent_count }}</td>
              {% else %}
              <td>{{ notification.topic }}</td>
              {% endif %}
              <td></td>
              <td>{{ notification.publish_on }}</td>
              <td><a onclick="return getCreator('{{ notification.creator }}')">{{ notification.creator }}</a></td>
              <td>{{ notification.sent_count }}</td>
              <td>{{ notification.open }}</td>
              <td>{{ notification.rate }}</td>
              <td></td>
              <td><a class="btn btn-primary" href="{% url 'xadmin:notification_detail' notification.pk %}" role="button"><i class="fa fa-search"></i></a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="automated-message" class="tab-pane fade">
      <table>
        <thead class="thead-dark">
          <tr>
            <th style="width: 3%;">#</th>
            <th style="width: 20%;">SUBJECT</th>
            <th style="width: 10%;">CAMPAIGN</th>
            <th style="width: 12%;">GROUP</th>
            <th style="width: 5%;">BONUS</th>
            <th style="width: 15%;">CREATED</th>
            <th style="width: 13%;">AUTHOR</th>
            <th style="width: 5%;">SENT</th>
            <th style="width: 5%;">OPENED</th>
            <th style="width: 5%;">OPEN RATE</th>
            <th style="width: 7%;">BONUS CTR</th>
          </tr>
        </thead>
        <tbody>
          {% for notification in auto_messages %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ notification.subject }}</td>
              <td>{{ notification.campaign }}</td>
              <!--<td>{{ notification.sent_count }}</td>-->
              <td>GROUP</td>
              <td>{{ notification.bonus }}</td>
              <td>{{ notification.publish_on }}</td>
              <td>{{ notification.creator }}</td>
              <td>{{ notification.sent_count }}</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td><a class="btn btn-primary" href="{% url 'xadmin:notification_detail' notification.pk %}" role="button"><i class="fa fa-search"></i></a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="draft" class="tab-pane fade">
      <table>
        <thead class="thead-dark">
          <tr>
            <th style="width: 25%;">SUBJECT</th>
            <th style="width: 15%;">CAMPAIGN</th>
            <th style="width: 15%;">GROUP</th>
            <th style="width: 5%;">BONUS</th>
            <th style="width: 15%;">CREATED</th>
            <th style="width: 13%;">AUTHOR</th>
            <th style="width: 12%;">STATUS</th>
          </tr>
        </thead>
        <tbody id='user_list_tbody'>
          {% for notification in notifications %} 
            <tr>
              <td>{{ notification.subject }}</td>
              <td>{{ notification.campaign }}</td>
              <td>{{ notification.topic }}</td>
              <td>{{ notification.bonus }}</td>
              <td>{{ notification.publish_on }}</td>
              <td>{{ notification.creator }}</td>
              <td>{{ notification.status }}</td>
              <td><a class="btn btn-primary" href="#" role="button">EDIT</a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="row user-list-control-group">
  <div class='col-md-9' style="margin-right: 70px"></div>
  <div class='col-md-1' style="width:10%">
    <div>SHOW ROWS</div>
    <select id="pagination_value"  class="form-control">
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="250">250</option>
    </select>
  </div>
  <div class='col-md-1'>
    <div>&nbsp;</div>
    <ul class="pagination" style="margin:0px;">
        {% if notifications.has_previous  %}
            <li class="page-item " id='previousPage'>
              <a class="page-link" href="javascript:getPrevious();"><i class='fas fa-caret-left'></i></a>
            </li>
        {% else %}
            <li class="page-item disabled" id='previousPage'>
              <a class="page-link" href="javascript:getPrevious();"><i class='fas fa-caret-left'></i></a>
            </li>
        {% endif %}
        {% if notifications.has_next %}
            <li class="page-item" id='nextPage'><a class="page-link" href="javascript:getNext();"><i class='fas fa-caret-right'></i></a></li>
        {% else %}
            <li class="page-item disabled" id='nextPage'><a class="page-link" href="javascript:getNext();"><i class='fas fa-caret-right'></i></a></li>
        {% endif %}
    </ul>
  </div>
</div>

<div class="modal fade" id="viewUser" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">User Profile</h4>
            </div>
            <div class="modal-body" style="height: 545px;">
                <div class="row">
                    <div class="col-md-2">
                        <img src="{{ imagePath }}happyface.png" alt="happyface" style="width: 100%;height: 100%;">
                    </div>
                    <div class="col-md-10">
                        <div class="name-title" id="viewName">Martin Sandstrom</div>
                        <div class="name-username" id="viewUsername">msandstrom</div>
                    </div>
                </div>
                <div style="background-color: #f5f5f5; height: 98px; margin-top: 20px">
                    <div class="row" style="padding: 20px 15px;">
                        <div class="col-md-2">Email: </div>
                        <div class="view-text col-md-10" id="viewEmail">ibet@gmail.com</div>
                    </div>
                    <div class="row" style="padding: 0px 15px;">
                        <div class="col-md-2">Phone: </div>
                        <div class="view-text col-md-10" id="viewPhone">3332929292</div>
                    </div>
                </div>
                <div class="row" style="margin-top:25px;">
                    <div class="col-md-3 profile-title">
                        MARKET
                    </div>
                    <div class="col-md-1 profile-info">
                        ibet
                    </div>
                    <div class="col-md-8 profile-info" id="viewIbetMarket">
                        <!-- <div>FE</div> -->
                        <div class="inline icon-margin"><img src="{{ imagePath }}china.svg" alt="china" class="flag-icon"><label style="margin-left:2%;">CNY</label></div>
                        <div class="inline sec-icon-margin"><img src="{{ imagePath }}china.svg" alt="china" class="flag-icon"><label style="margin-left:2%;">CNY</label></div>
                    </div>
                </div>
                <div class="row" style="margin-top:15px;">
                    <div class="col-md-3">
                    </div>
                    <div class="col-md-1 profile-info">
                        Letou
                    </div>
                    <div class="col-md-8 profile-info" id="viewLetouMarket">
                        FO
                    </div>
                </div>
                <div>
                    <hr style="width: 100%">
                </div>
                <div class="row" style="margin-top:25px;">
                    <div class="col-md-3 profile-title">
                        ROLE
                    </div>
                    <div class="col-md-9 profile-info" id="viewRole">
                        ROLE
                    </div>
                </div>
                <div class="row" style="margin-top:25px;">
                    <div class="col-md-3 profile-title">
                        DEPARTMENT
                    </div>
                    <div class="col-md-9 profile-info"  id="viewDepartment">
                        DEPARTMENT
                    </div>
                </div>
                <div>
                    <hr style="width: 100%">
                </div>
            </div>
        </div>
        
    </div>
</div>

<script>
/*
// Instantiate the Bloodhound suggestion engine
var movies = new Bloodhound({
  datumTokenizer: function (datum) {
    return Bloodhound.tokenizers.whitespace(datum.value);
  },
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: 'http://api.themoviedb.org/3/search/movie?query=%QUERY&api_key=f22e6ce68f5e5002e71c20bcba477e7d',
    filter: function (movies) {
      // Map the remote source JSON array to a JavaScript object array
      return $.map(movies.results, function (movie) {
          return {
              value: movie.original_title
          };
      });
    }
  }
});

// Initialize the Bloodhound suggestion engine
movies.initialize();

// Instantiate the Typeahead UI
$('.typeahead').typeahead(null, {
  displayKey: 'value',
  source: movies.ttAdapter()
});

$( function() {
    var availableTags = [
      "ActionScript",
      "AppleScript",
      "Asp",
      "BASIC",
      "C",
      "C++",
      "Clojure",
      "COBOL",
      "ColdFusion",
      "Erlang",
      "Fortran",
      "Groovy",
      "Haskell",
      "Java",
      "JavaScript",
      "Lisp",
      "Perl",
      "PHP",
      "Python",
      "Ruby",
      "Scala",
      "Scheme"
    ];
    $( "#tags" ).autocomplete({
      source: availableTags
    });
  });

  $("#tags").autocomplete({
    appendTo: "#mydialog"
  });
*/

$.ajax({
    type:'GET',
    url:"{% url 'notifier-tags' %}",
    success:function(data) {
    //   console.log(data);
      var group = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace("name"),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        local: data["group"]
      });

      var member = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace("name"),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        local: data["member"]
      });

      group.initialize();
      member.initialize();

      $('#sendto').tagsinput({
          itemValue: "name",
          itemText: "name",
          typeaheadjs: [{
            highlight: false
          },[{
              name: 'member',
              display: 'name',
              source: member,
              templates: {
                header: '<li class="ui-state-disabled search-result" style="margin: 0px 13px;">MEMBER RESULTS</li>',
                suggestion: function(data) {
                              return '<div style="margin: 0px 13px;"><i class="fas fa-user" style="padding: 7px; font-size: 0.83em;"></i>' + data.name + '</div>'
                            }
              }
          },{
              name: 'group',
              display: 'name',
              source: group,
              templates: {
                header: '<li class="ui-state-disabled search-result" style="margin: 0px 13px;">GROUP RESULTS</li>',
                suggestion: function(data) {
                              return '<div style="margin: 0px 13px;"><i class="fas fa-user-friends" style="padding: 7px; font-size: 0.83em;"></i>' + data.name + '</div>'
                            }
              }
          }]],
          freeInput: true
      });
    }
});

/*
$('.tt-suggestion').click(function() {
  alert("Hi");
});
*/

$(document).ready(function() {
  var previousURL = document.referrer;
  // parse url
  paramsMap = {
      'search': '',
      'from': '',
      'to': '',
      'pageSize': 20,
      'offset': 1,
      'tab': 2
  };

  var parsedUrl = new URL(window.location.href);
  if (parsedUrl.searchParams.get("search") !== null) {
      paramsMap['search'] = parsedUrl.searchParams.get("search");
  }
  if (parsedUrl.searchParams.get("from") !== null) {
      paramsMap['from'] = parsedUrl.searchParams.get("from");
  }
  if (parsedUrl.searchParams.get("to") !== null) {
      paramsMap['to'] = parsedUrl.searchParams.get("to");
  }
  if (parsedUrl.searchParams.get("pageSize") !== null) {
      paramsMap['pageSize'] = Number(parsedUrl.searchParams.get("pageSize"));
  }
  if (parsedUrl.searchParams.get("offset") !== null) {
      paramsMap['offset'] = Number(parsedUrl.searchParams.get("offset"));
  }
  if (parsedUrl.searchParams.get("tab") !== null) {
      paramsMap['tab'] = Number(parsedUrl.searchParams.get("tab"));
  }

  if (parsedUrl.searchParams.get("tab") == 0) {
    $("#automated-messages").addClass('active');
    $("#automated-message").addClass('tab-pane fade in active');
    $("#sent-messages").removeClass('active');
    $("#sent-message").removeClass('tab-pane fade in active');
    $("#sent-message").addClass('tab-pane fade');
    $("#drafts").removeClass('active');
    $("#draft").removeClass('tab-pane fade in active');
    $("#draft").addClass('tab-pane fade');
  } else if(parsedUrl.searchParams.get("tab") == 1) {
    $("#drafts").addClass('active');
    $("#draft").addClass('tab-pane fade in active');
    $("#automated-messages").removeClass('active');
    $("#automated-message").removeClass('tab-pane fade in active');
    $("#automated-message").addClass('tab-pane fade');
    $("#sent-messages").removeClass('active');
    $("#sent-message").removeClass('tab-pane fade in active');
    $("#sent-message").addClass('tab-pane fade');
  } else {
    $("#sent-messages").addClass('active');
    $("#sent-message").addClass('tab-pane fade in active')
    $("#automated-messages").removeClass('active');
    $("#automated-message").removeClass('tab-pane fade in active');
    $("#automated-message").addClass('tab-pane fade');
    $("#drafts").removeClass('active');
    $("#draft").removeClass('tab-pane fade in active');
    $("#draft").addClass('tab-pane fade');
  }

  $("a[data-toggle='tab']").click(function() {
    var active = $(this).attr("href");
    if (active == "#sent-message") {
      paramsMap['tab'] = 2;
    } else if (active == "#draft") {
        paramsMap['tab'] = 1;
    } else {
        paramsMap['tab'] = 0;
    }
    var pageSize = paramsMap['pageSize'];

    var tab = paramsMap['tab'];
    
    window.location.href = getUserListRedirectUrl(pageSize, 1, tab, "", "", "");
  });

  $('#pagination_value').val(paramsMap['pageSize']);

  $('#search').val(paramsMap['search']);

  $('#notification_time_from').datepicker({
        autoclose: true, 
        todayHighlight: true,
        endDate: new Date()
    }).val("");

  $('#notification_time_to').datepicker({ autoclose: true, 
        todayHighlight: true,
        endDate: new Date()
    }).val("");

  $('#italic').click(function() {
    document.execCommand('italic');
  });

  $('#bold').click(function() {
    document.execCommand('bold');
  });

  $('#underline').click(function() {
    document.execCommand('underline');
  });

  // CKEditor
  /*
  ClassicEditor
  .create( document.querySelector( '#editor' ) )
  .then( editor => {
    console.log( editor );
  } )
  .catch( error => {
    console.error( error );
  } );
  */

  $('#pagination_value').change(function() {
    var pageSize = this.value;
    var offset = paramsMap['offset'];
    var tab = paramsMap['tab'];
    var search = paramsMap['search'];
    var t_from = paramsMap['from'];
    var t_to = paramsMap['to'];
    window.location.href = getUserListRedirectUrl(pageSize, 1, tab, search, t_from, t_to);
  });

  $("#search-btn").click(function() {
    var pageSize = $("#pagination_value").val();
    var search = $('#search').val();
    var tab = paramsMap['tab'];
    var t_from = paramsMap['from'];
    var t_to = paramsMap['to'];
    window.location.href = getUserListRedirectUrl(pageSize, 1, tab, search, t_from, t_to);
  });

  $("#search").on('keyup', function () {
    if( this.value.length < 2 ) return;
      searchOpen();
  });

  $(function () {
    $('#notification_time_from').datepicker();
    $('#notification_time_to').datepicker();
  });

  $("#date-search-btn").click(function() {
    var time_from = $('#notification_time_from').val();
    time_from = moment(time_from).format('YYYY-MM-DD');
    // console.log(time_from);
    // time_from = time_from.format('YYYY-MM-DD HH:mm');
    var time_to = $('#notification_time_to').val();
    time_to = moment(time_to).format('YYYY-MM-DD');
    // console.log(time_to);
    if (time_from.indexOf("Invalid") >= 0) {
        time_from = '';
    }
    if (time_to.indexOf("Invalid") >= 0) {
        time_to = '';
    }
    var search = $('#search').val();
    var pageSize = $("#pagination_value").val();
    var tab = paramsMap['tab'];
    window.location.href = getUserListRedirectUrl(pageSize, 1, tab, search, time_from, time_to);    
  });

  $("#send").click(function() {
    $(this).text('Double click to send');
  });

  $("#send").dblclick(function() {
    $("#newmsg").submit();
  });


  var member_list = [];
  var group_list = [];

  $("#sendto").on('itemAdded', function(event) {
      
    var data = event.item;
    if(data.type == "member") {
      member_list.push(data.name);
    }
    else if(data.type == "group") {
      group_list.push(data.name);
    }
  });

  $("#sendto").on('itemRemoved', function(event) {
    var data = event.item;
    if(data.type == "member") {
      var index = member_list.indexOf(data.name);
      if (index > -1) {
        member_list.splice(index, 1);
      }
    }
    else if(data.type == "group") {
      var index = group_list.indexOf(data.name);
      if (index > -1) {
        group_list.splice(index, 1);
      }
    }
  });

  $("#newmsg").submit(function(e) {
    e.preventDefault();
    var form = $(this);
    var subject = form.find('input[name="subject"]').val();
    var content_text = $('#content_text').html();
    var campaign = form.find('select[name="campaign"]').val();
    
    var direct = form.find('input[name="direct_check"]').prop('checked');
    var sms = form.find('input[name="SMS_check"]').prop('checked');
    var email = form.find('input[name="email_check"]').prop('checked');
    var push = form.find('input[name="push_check"]').prop('checked');
    if (campaign === "-1") {
        campaign = null;
    }

    $.ajax({
    type: "POST",
    url: "{% url 'xadmin:notification' %}",
    data: {
        csrfmiddlewaretoken: "{{ csrf_token }}",
        campaign: campaign,
        subject: subject,
        content_text: content_text,
        group_list: JSON.stringify(group_list),
        member_list: JSON.stringify(member_list),
        direct_check: direct,
        SMS_check: sms,
        email_check: email,
        push_check: push,
    },
    success: function(data)
        {
        window.location.reload();
        }
    });
    
  });

/*
  $("#sendto").on('keyup', function () {
    if( this.value.length < 2 ) return;
      searchUsers();
  });
*/

  $("#search-notifier-btn").click(function() {
    // console.log($('#sendto').val());
    // console.log(member_list);
    // console.log(group_list);
  });


  function searchUsers() {
    var search = $('#sendto').val();
    var url = "{% url 'notifier-search' %}" + "?search=" + search;

    $.ajax({
      url: url,
      type: 'GET',
      success: function (data) {
        // console.log(data);
        tagsAuto(data);
        //get data pass to json
        //searchNotifier(data, search);
      },
      error: function () {
        // console.log('error');
      }
    });
  }

  //insert data to input in load page
  /*
  elt.tagsinput("add", {
    value: 1,
    text: "task 1",
    continent: "task"
  });
  */

  function searchNotifier(data, term) {
    var member_data = data['member_data'];
    // var content = data['body'];

    var sourceList = [];

    if (member_data.length > 0) {
      sourceList.push({
        'type': 'category',
        'label': term,
        'value': 'MEMBER RESULTS'
      });
      for (var i = 0; i < member_data.length; i++) {
        sourceList.push({
          'type': 'member',
          'label': term,
          'value': member_data[i]['member'],
        });
      }
    }
    $( "#sendto" ).autocomplete({
      source: sourceList,
      create: function () {
        $(this).data('ui-autocomplete')._renderItem = function (ul, item) {
          if (item.type === 'category') {
            return $('<li class="ui-state-disabled search-result" style="margin: 0px 13px;">')
            .append(item.value)
            .appendTo(ul);
            // ul.append("<li class='ui-autocomplete-group'>" + item.value + "</li>");
          } else {
            var url = ""
            if (item.type == 'member') {
              return $('<li>')
              .append('<div style="margin: 0px 13px;"><a href="#" class="tp"><i class="far fa-user" style="padding: 7px; font-size: 0.83em;" aria-hidden="true"></i>' + item.value + '</a></div>')
              .appendTo(ul);
            }
          }
        };
      }
    });
  }

  function searchOpen() {
    var search = $('#search').val();
    var tab = paramsMap['tab'];
    var url = "{% url 'notification-search' %}" + "?search=" + search + "&tab=" + tab;
    $.ajax({
      url: url,
      type: 'GET',
      success: function (data) {
        // console.log(data);
        searchResult(data, search);
      },
      error: function () {
        // console.log('error');
      }
    });
  }

  function searchResult(data, term) {
    var subject = data['subject'];
    var campaign = data['campaign'];
    // var content = data['body'];

    var sourceList = [];

    if (subject.length > 0) {
      sourceList.push({
        'type': 'category',
        'label': term,
        'value': 'MESSAGE RESULTS'
      });
      for (var i = 0; i < subject.length; i++) {
        sourceList.push({
          'type': 'subject',
          'label': term,
          'value': subject[i]['subject'],
          'id': subject[i]['id'],
        });
      }
    }
    if (campaign.length > 0) {
      sourceList.push({
        'type': 'category',
        'label': term,
        'value': 'CAMPAIGN RESULTS'
      });
      for (var i = 0; i < campaign.length; i++) {
        sourceList.push({
          'type': 'campaign',
          'label': term,
          'value': campaign[i]['campaign'],
          'id': campaign[i]['id'],
        });
      }
    }
    /*
    if (content.length > 0) {
      sourceList.push({
        'type': 'category',
        'label': term,
        'value': 'MESSAGE RESULTS'
      });
      for (var i = 0; i < content.length; i++) {
        sourceList.push({
          'type': 'message body',
          'label': term,
          'value': content[i]['body'],
        });
      }
    }
    */
    $( "#search" ).autocomplete({
      source: sourceList,
      create: function () {
        $(this).data('ui-autocomplete')._renderItem = function (ul, item) {
          if (item.type === 'category') {
            return $('<li class="ui-state-disabled search-result" style="margin: 0px 13px;">')
            .append(item.value)
            .appendTo(ul);
            // ul.append("<li class='ui-autocomplete-group'>" + item.value + "</li>");
          } else {
            var url = "{% url 'xadmin:notification_detail' 123 %}".replace('123', item.id);
            // var url = ""
            if (item.type == 'subject') {
              return $('<li>')
              .append('<div style="margin: 0px 13px; color:blue;"><a href="' + url + '"><i class="fa fa-envelope" style="padding: 7px; font-size: 0.83em;" aria-hidden="true"></i>' + item.value + '</a></div>')
              .appendTo(ul);
            } else if (item.type == 'campaign') {
              return $('<li>')
              .append('<div style="margin: 0px 13px; color:blue;"><a href="' + url + '"><i class="fas fa-bullhorn" style="padding: 7px; font-size: 0.83em;" aria-hidden="true"></i>' + item.value + '</a></div>')
              .appendTo(ul);
            }
          }
        };
      }
    });
  }

  getNext = function() {
    if ($('#nextPage').hasClass('disabled')) {
        return;
    }
    var pageSize = paramsMap['pageSize'];
    var oldFromItem = paramsMap['offset'];
    // var newFromItem = Number(oldFromItem) + Number(pageSize);
    var newFromItem = Number(oldFromItem) + 1;
    var tab = paramsMap['tab'];
    var search = paramsMap['search'];
    var t_from = paramsMap['from'];
    var t_to = paramsMap['to'];
    
    window.location.href = getUserListRedirectUrl(pageSize, newFromItem, tab, search, t_from, t_to);
  }

  getPrevious = function () {
      if ($('#previousPage').hasClass('disabled')) {
          return;
      }
      var pageSize = paramsMap['pageSize'];
      var oldFromItem = paramsMap['offset'];
      // var newFromItem = Number(oldFromItem) - Number(pageSize);
      var newFromItem = Number(oldFromItem) - 1;
      var tab = paramsMap['tab'];
      var search = paramsMap['search'];
      var t_from = paramsMap['from'];
      var t_to = paramsMap['to'];
      
      window.location.href = getUserListRedirectUrl(pageSize, newFromItem, tab, search, t_from, t_to);
  }
});

function getUserListRedirectUrl(pageSize, offset, tab, search, t_from, t_to) {
  var curUrl = window.location.href;
  var parts = curUrl.split('?');
  
  var redirectUrl = parts[0];
  redirectUrl += '?search=' + search;
  redirectUrl += '&from=' + t_from;
  redirectUrl += '&to=' + t_to;
  redirectUrl += "&pageSize=" + pageSize;
  redirectUrl += '&offset=' + offset;
  redirectUrl += '&tab=' + tab;

  return redirectUrl;
}

function getCreator(username) {
    // console.log(username);
    $('#viewUser').modal({'show' : true});

    $.ajax({
        type: "GET",
        url: "{% url 'get_admin_profile' %}",
        data:{ 
            'username': username,
        },
        success: function(response)
        {   
            // console.log(response);
            var data = response.data;
            if (response.code === 0) {
                var username = data.username;
                var firstName = data.first_name;
                var lastName = data.last_name;
                var email = data.email;
                var phone = data.phone;
                var role = data.roleName;
                var department = data.department;
                var ibetMarkets = data.ibetMarkets;
                var letouMarkets = data.letouMarkets;
                $('#viewEmail').text(email);
                $('#viewPhone').text(phone);
                $('#viewRole').text(role);
                $('#viewDepartment').text(department);
                if (!firstName && !lastName) {
                    $('#viewName').text(username);
                    $('#viewUsername').text('');
                } else {
                    $('#viewName').text(firstName + ' ' + lastName);
                    $('#viewUsername').text(username);
                }
                
                var content = '';
                for (var i = 0; i < ibetMarkets.length; i++) {
                    // console.log(ibetMarkets[i].name);
                    content += '<div class="inline" style="margin-left: -20px;"><img src="{{ imagePath }}' + ibetMarkets[i].name + '.svg" alt="' + ibetMarkets[i].name + '" class="flag-icon"><label style="margin-left:2%;">' + ibetMarkets[i].code + '</label></div>';
                }
                // console.log(content);
                $('#viewIbetMarket').empty();
                $('#viewIbetMarket').append(content);


                var content = '';
                for (var i = 0; i < letouMarkets.length; i++) {
                    // console.log(ibetMarkets[i].name);
                    content += '<div class="inline" style="margin-left: -20px;"><img src="{{ imagePath }}' + letouMarkets[i].name + '.svg" alt="' + letouMarkets[i].name + '" class="flag-icon"><label style="margin-left:2%;">' + ibetMarkets[i].code + '</label></div>';
                }
                // console.log(content);
                $('#viewLetouMarket').empty();
                $('#viewLetouMarket').append(content);
            }
        }
    });
}
</script>
{% endblock %}