{% extends 'xadmin/base_site.html' %}
{% block content-nav %}
{% endblock %}
{% block content %}

<style>
form {
  padding: 0 16px 16px 16px;
}

p, label {
  height: 13px;
  font-family: Helvetica;
  font-size: 11px;
  font-weight: normal;
  font-style: normal;
  font-stretch: normal;
  line-height: normal;
  letter-spacing: normal;
  color: #4a4a4a;
}

thead {
  height: 12px;
  font-family: Helvetica;
  font-size: 10px;
  font-weight: normal;
  font-style: normal;
  font-stretch: normal;
  line-height: normal;
  letter-spacing: normal;
  color: #4a4a4a;
}

td {
  border: solid 4px #ffffff;
}

tbody>tr:nth-child(odd)>td, 
tbody>tr:nth-child(odd)>th {
   background-color: #f3f3f3;
}

.modal-header {
  border-radius: 4px;
  border: solid 1px #bdbdbd;
  background-color: #f5f5f5;
}

.modal-header .close {
  margin-top: -16px;
}

.row {
  margin: 0 0 0 0;
}

.form-group {
  padding-top: 20px;
  border-bottom: 0;
}

#details {
  width: 95%;
  background-color: #f3f3f3;
  margin: 16px 16px 16px 16px;
}

#csv_file {
  display: none;
}
</style>

<h2 id="demo"></h2>
<!--<a href="/notification/create_message.html" class="btn btn-primary btn-lg active" role="button" aria-pressed="true">Create a new message</a>-->
{% if err_msg %}<p><strong>{{ err_msg }}</strong></p>{% endif %}

<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#create_group">New group</button>

<div class="modal fade bd-example-modal-lg" id="create_group" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">New group</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <ul class="nav nav-tabs">
        <li id="member-group"><a data-toggle="tab" class="tab-label active" href="#membergroup">MEMBER GROUP</a></li>
        <li id="automated-messages"><a data-toggle="tab"  class="tab-label" style="width: 220px"  href="#automated-message">AUTOMATED MESSAGES</a></li>
      </ul>
      <div class="tab-content">
        <div id="membergroup" class="tab-pane active">
          <form id="newgroup">
            {% csrf_token %}
              <div class="form-group">
                <label for="group_name">NAME</label>
                <input type="text" class="form-control" name="group_name" placeholder="Give your group a descriptive name" required>
              </div>
              <div class="row" style="margin-top: 30px">
                <strong>FILTER TO DEFINE YOUR GROUP (LEAVE BLANK TO IGNORE FILTER)</strong>
              </div>
              <div class="form-group">
                <label for="product">PRODUCT</label>
                <br/>
                <div class="btn-group">
                  <button type="button" id="product" name="product" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    Select...
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu">
                      <li class="product-item"><a href="#">Sports</a></li>
                      <li class="product-item"><a href="#">Live Casino</a></li>
                      <li class="product-item"><a href="#">Games</a></li>
                      <li class="product-item"><a href="#">Lotto</a></li>
                  </ul>
                </div>
              </div>
              <div class="form-group">
                <div class="row">
                  <div class="col-md-5" id="daystotal" style="padding-left: 0">
                    <label style="margin-left:36px">LAST ACTIVE DATE</label>
                    <div class="input-group">
                      <span class="input-group-addon" style="background-color:#ffffff; border: 0"><input type="radio" id="total" name="days" value="total" checked></span>
                      <span class="input-group-addon" style="background-color:#f3f3f3; color:black">â‰¤</span>
                      <input type="number" id="days" class="form-control" min="1">
                      <span class="input-group-addon" style="background-color:#f3f3f3; color:black">Days ago</span>
                    </div>
                  </div>
                  <div class="col-md-7" id="daysrange" style="padding-left: 0">
                    <label style="margin-left:36px">LAST ACTIVE DATE</label>
                    <div class="input-group">
                      <span class="input-group-addon" style="background-color:#ffffff; border: 0"><input type="radio" id="range" name="days" id="range"></span>
                      <span class="input-group-addon" style="background-color:#f3f3f3; color:black">From</span>
                      <input type="text" id="from_date" class="form-control" placeholder="Pick a time..." disabled>
                      <span class="input-group-addon" style="background-color:#f3f3f3; color:black">To</span>
                      <input type="text" id="to_date" class="form-control" placeholder="Pick a time..." disabled>
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <div class="row">
                  <div class="col-md-8" style="padding-left: 0">
                    <label>REGISTRATION DATE</label>
                    <div class="input-group">
                      <span class="input-group-addon" style="background-color:#f3f3f3; color:black">From</span>
                      <input type="text" id="reg-from" class="form-control" placeholder="Pick a time...">
                      <span class="input-group-addon" style="background-color:#f3f3f3; color:black">To</span>
                      <input type="text" id="reg-to" class="form-control" placeholder="Pick a time...">
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <input class="form-check-input" type="checkbox" id="onlyactive" checked disabled>
                <label class="form-check-label" for="gridCheck">
                  Only active members (you can override this filter by adding members manually)
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="onlydeposited">
                <label class="form-check-label" for="gridCheck">
                  Only members who has deposited
                </label>
              </div>
              <div class="form-group">
                <label for="vip">VIP LEVEL</label>
                <div class="dropdown">
                  <button id="vipbtn" class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                    <span>Select...</span>
                    <span class="caret"></span>
                  </button>
                  <ul id="vip" class="dropdown-menu">
                    <li><a href="#" class="small" data-value="ALL" tabIndex="-1"><input type="checkbox"/>&nbsp;ALL</a></li>
                    <li><a href="#" class="small" data-value="Normal" tabIndex="-1"><input type="checkbox"/>&nbsp;Normal</a></li>
                    <li><a href="#" class="small" data-value="VIP1" tabIndex="-1"><input type="checkbox"/>&nbsp;VIP1</a></li>
                    <li><a href="#" class="small" data-value="VIP2" tabIndex="-1"><input type="checkbox"/>&nbsp;VIP2</a></li>
                    <li><a href="#" class="small" data-value="VIP3" tabIndex="-1"><input type="checkbox"/>&nbsp;VIP3</a></li>
                    <li><a href="#" class="small" data-value="VIP4" tabIndex="-1"><input type="checkbox"/>&nbsp;VIP4</a></li>
                    <li><a href="#" class="small" data-value="VIP5" tabIndex="-1"><input type="checkbox"/>&nbsp;VIP5</a></li>
                  </ul>
                </div>
              </div>
              <div class="form-group">
                <label for="risk">RISK LEVEL</label>
                <div class="dropdown">
                  <button id="riskbtn" class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                    Select...
                    <span class="caret"></span>
                  </button>
                  <ul id="risk" class="dropdown-menu">
                    <li><a href="#" class="small" data-value="ALL" tabIndex="-1"><input type="checkbox"/>&nbsp;ALL</a></li>
                    <li><a href="#" class="small" data-value="E1" tabIndex="-1"><input type="checkbox"/>&nbsp;E1</a></li>
                    <li><a href="#" class="small" data-value="E2" tabIndex="-1"><input type="checkbox"/>&nbsp;E2</a></li>
                    <li><a href="#" class="small" data-value="W" tabIndex="-1"><input type="checkbox"/>&nbsp;W</a></li>
                    <li><a href="#" class="small" data-value="F" tabIndex="-1"><input type="checkbox"/>&nbsp;F</a></li>
                  </ul>
                </div>
              </div>
              <hr/>
              <div class="form-group" style="padding-top: 0">
                <p style="font-size: 14px"><strong>ADD MEMBERS MANUALLY</strong></p>
                <p>Manually added members will stay in the groups regardless of filter settings.</p>
                <p>You have added 0 members manually.</p>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#manually">Add members</button>
              </div>
              <hr/>
              <div class="form-group" style="padding-top: 0">
                <label>Members in group</label>
                <div class="row" style="background-color:#f3f3f3">
                  <span><a href="#" id="member_count" data-toggle="modal" data-target="#view-group">&nbsp;{{ users_count }}</a></span>
                </div>
              </div>
              <div class="row">
                  <button type="submit" class="btn btn-primary">Save</button>
                  {% comment %} <button type="button" id="create_group" class="btn btn-primary">Save</button> {% endcomment %}
                  <button type="reset" class="btn btn-primary">Cancel</button>
              </div>
          </form>
        </div>
        <div id="automated-message" class="tab-pane fade">
          abc
        </div>
      </div>
    </div>
  </div>
</div>

{% comment %} <div class="modal fade bd-example-modal-lg" id="view-group" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">View group</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <label>GROUP DETAILS</label>
      <table id="details">
        <tbody>
          <tr>
            <td>TBD</td>
            <td>TBD</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div> {% endcomment %}

<div class="modal fade bd-example-modal-lg" id="manually" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add manually to group</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="row" style="margin-top: 31px; margin-left: 16px">
        <div class='col-md-9' style="padding-left: 0">
          <div class="input-group">
            <input type="text" id="search" class="form-control" placeholder="Enter member, campaign, bouns, keyword...">
            <span id="search-btn" class="input-group-addon" style="background-color: #428bca; color:white"><span class="glyphicon glyphicon-search"></span></span>
          </div>
        </div>
        <div class='col-md-3' style="padding-left: 0">
          <button class="btn btn-primary" id="csv_btn">Upload CSV</button>
          <input type="file" id="csv_file">
        </div>
      </div>
      <button class="btn btn-primary" style="margin-top: 20px; margin-left: 16px">Add member to group</button>
      <table id="details">
        <tbody>
          <tr>
            <td>TBD</td>
            <td>TBD</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<table>
  <thead class="thead-dark">
    <tr>
      <th style="width: 40%;">NAME</th>
      <th style="width: 15%;">MEMBERS</th>
      <th style="width: 15%;">TIMES USED</th>
      <th style="width: 15%;">CREATOR</th>
      <th style="width: 15%;">OPEN RATE</th>
    </tr>
  </thead>
  <tbody>
  {% for group in message_groups %}
    <tr>
      <td>{{ group.name }}</td>
      <td>{{ group.members }}</td>
      <td>{{ group.time_used }}</td>
      <td>{{ group.creator }}</td>
      <td>66.67%</td>
      <td><a class="btn btn-primary" href="#" role="button" disabled>Edit</a></td>
      <td><a class="btn btn-primary" href="#" role="button" disabled><i class="fa fa-info"></i></a></td>
      <!--<td><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#details">
        <i class="fa fa-info"></i>
      </button></td>-->
    </tr>
    <!--<li><strong>Notification:</strong> {{ notification }}</li>-->
  {% endfor %}
  </tbody>
</table>
<script>
var pk_list;

$(document).ready(function() {
  var userFilter = {
    'product': null,
    'active': null,
    'active_from': null,
    'active_to': null,
    'register_from': null,
    'register_to': null,
    'deposit': false,
    'vip': null,
    'risk': null,
  }

  var user_list = [];

  $('.product-item').click(function() {
    $("#product").html($(this).text() + '<span class="caret"></span>');
    $("#product").val($(this).text());
    userFilter['product'] = $('#product').val();
    groupFilter();
  });

  $('#from_date').datepicker({
    onClose: function() {
      userFilter['active_from'] = $(this).val();
      groupFilter();
    }
  });

  $('#to_date').datepicker({
    onClose: function() {
      userFilter['active_to'] = $(this).val();
      groupFilter();
    }
  });

  $('#total').change(function() {
    $('#days').prop('disabled', false);
    $('#from_date').prop('disabled', true);
    $('#to_date').prop('disabled', true);
  });

  $('#range').change(function() {
    $('#days').prop('disabled', true);
    $('#from_date').prop('disabled', false);
    $('#to_date').prop('disabled', false);
  });

  $('#reg-from').datepicker({
    onClose: function() {
      userFilter['register_from'] = $(this).val();
      groupFilter();
    }
  });

  $('#reg-to').datepicker({
    onClose: function() {
      userFilter['register_to'] = $(this).val();
      groupFilter();
    }
  });



  $('input:radio[name="days"]').change(function() {
    if ($(this).is(':checked') && $(this).val() == 'total') {
      $('#daysrange').prop("disabled", true);
    }
  });

  $('#days').focusout(function() {
    userFilter['active'] = $(this).val();
    groupFilter()
  })

  var options = [];

  $('#vip.dropdown-menu a').on('click', function(event) {
    var $target = $(event.currentTarget),
        val = $target.attr('data-value'),
        $inp = $target.find('input'),
        idx;

    if(val == "ALL") {
      if($inp.prop('checked')) {
        $('#vip li input[type=checkbox]').each(function() {
          this.checked = $inp.prop('checked');
          options.push($(this).parent().attr('data-value'));
        });
      } else {
        $('#vip li input[type=checkbox]').each(function() {
          this.checked = $inp.prop('checked');
          options.pop();
        });
      }
    } else {
      if((idx = options.indexOf(val)) > -1) {
        options.splice(idx, 1);
        // $('#vip-all').prop('checked', false);
        setTimeout(function() { $inp.prop('checked', false)}, 0);
      } else {
        options.push(val);
        setTimeout(function() { $inp.prop('checked', true)}, 0);
      }
    }
    
    
    $(event.target).blur();
    
    console.log(options)

    $("#vipbtn").html(options.length + " Selected " + '<span class="caret"></span>');

  });

  var riskOptions = [];

  $('#risk.dropdown-menu a').on('click', function(event) {
    var $target = $(event.currentTarget),
        val = $target.attr('data-value'),
        $inp = $target.find('input'),
        idx;

    if(val == "ALL") {
      var isAll = $inp.prop('checked');

      $('#risk li input[type=checkbox]').each(function() {
        this.checked = isAll;
      });
    }

    if((idx = riskOptions.indexOf(val)) > -1) {
      riskOptions.splice(idx, 1);
      setTimeout(function() { $inp.prop('checked', false)}, 0);
    } else {
      riskOptions.push(val);
      setTimeout(function() { $inp.prop('checked', true)}, 0);
    }
    
    $(event.target).blur();
    
    //console.log(options)

    $("#riskbtn").html(riskOptions.length + " Selected " + '<span class="caret"></span>');

    return false;
  });

  $('#csv_file').change(function(e) {
    var fileName = e.target.files[0].name;
    alert('The file "' + fileName +  '" has been selected.');

    readFile = function() {
      var reader = new FileReader();
      reader.onload = function() {
        console.log(reader.result);
      };

      reader.readAsBinaryString(fileInput.files[0]);
    };

    console.log(readFile);
  });

  $('#csv_btn').click(function() {
    $('#csv_file').click();
  });

  $('#newgroup').submit(function(e) {
    e.preventDefault();
    var form = $(this);
    var group_name = form.find('input[name="group_name"]').val();

    $.ajax({
      type: "POST",
      url: "{% url 'xadmin:messagegroups' %}",
      data: {
        csrfmiddlewaretoken: "{{ csrf_token }}",
        group_name: group_name,
        pk: pk_list,
      },
      success: function(data)
        {
          console.log("Success");
          {% comment %} if (data.code === 1) {
              $('#errorMessage').text(data.message); 
              $('#errorMessage').css('color', 'red'); 
          } else {
              window.location.reload();
          } {% endcomment %}
        }
    });
  });

  function groupFilter() {
    console.log(userFilter['product']);
    console.log(userFilter['active']);
    console.log(userFilter['register_from']);
    $.ajax({
      type: 'GET',
      url: "{% url 'group-filter' %}",
      data: { 
        'product': userFilter['product'],
        'active': userFilter['active'],
        'active_from': userFilter['active_from'],
        'active_to': userFilter['active_to'],
        'register_from': userFilter['register_from'],
        'register_to': userFilter['register_to'],
      },
      success: function(data) {
        console.log(data);
        $('#member_count').html("&nbsp;" + data["user_count"]);
        user_list = data["user"];
        pk_list = data["pk_list"];
      }
    });
  }

});


</script>
{% endblock %}